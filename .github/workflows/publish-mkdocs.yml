name: Build2

env:
  JVM_VERSION: '21'

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: "workflow = ${{ github.workflow }}, ref = ${{ github.event.ref }}, pr = ${{ github.event.pull_request.id }}"
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

defaults:
  run:
    shell: bash

permissions:
  contents: write
  pull-requests: write
  
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app:
          - section-1/step-01
          - section-1/step-02
          - section-1/step-03
          - section-1/step-04
          - section-1/step-05
          - section-1/step-06
          - section-1/step-07
          - section-1/step-08
          - section-1/step-09
          - section-1/step-10
          - section-1/step-11
          - section-2/step-01
          - section-2/step-02
          - section-2/step-03
          - section-2/step-04/multi-agent-system
          - section-2/step-04/remote-a2a-agent

    name: "Build ${{ matrix.app }}"
    steps:
      # REPLACEMENT: actions/checkout
      - name: Checkout Repository
        run: |
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} .
          git checkout ${{ github.sha }}

      # UPDATED STEP: Switch to Java 21 manually
      - name: Set Java 21 (Temurin)
        run: |
          echo "JAVA_HOME=$JAVA_HOME_21_X64" >> $GITHUB_ENV
          echo "$JAVA_HOME_21_X64/bin" >> $GITHUB_PATH


      # REPLACEMENT: actions/setup-java (Relies on runner's default Java)
      - name: Verify Java Version
        run: java -version

      - name: Maven Build for ${{ matrix.app }}
        working-directory: ${{ matrix.app }}
        run: |
          chmod +x mvnw
          ./mvnw -B clean verify -Dquarkus.http.host=0.0.0.0 -DskipITs=false

  docs:
    runs-on: ubuntu-latest
    name: "Build Docs"
    # Only run docs build on main push to save resources, or keep valid for PRs if desired
    steps:
      # REPLACEMENT: actions/checkout
      - name: Checkout Repository
        run: |
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} .
          git checkout ${{ github.sha }}

      # NEW STEP: Install the missing C libraries
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-dev libxslt-dev python3-dev

      # REPLACEMENT: actions/setup-python (Relies on runner's default Python)
      - name: Install Pipenv
        run: pip install pipenv

      - name: Generate documentation
        working-directory: docs
        run: |
          pipenv install
          pipenv run mkdocs build --clean
          # Output is now in docs/site

      # REPLACEMENT: peaceiris/actions-gh-pages
      - name: Publish documentation (manual)
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Configure Identity
          git config user.name "danieloh30"
          git config user.email "doh@redhat.com"

          # 2. Safe Move: Move the built artifact out of the git tree temporarily
          # We move 'docs/site' to a temp folder outside the repo
          mv docs/site ../site-content

          # 3. Handle the gh-pages branch
          # Fetch if exists, or create orphan
          git fetch origin gh-pages || git checkout --orphan gh-pages
          git checkout gh-pages 2>/dev/null || git checkout -b gh-pages

          # 4. Clean directory and move built site back
          rm -rf ./*
          cp -r ../site-content/* .
          
          # Add .nojekyll to ensure _underscore files (like _static) work
          touch .nojekyll

          # 5. Commit and Push
          git add .
          git commit -m "Deploy: Docs update" || echo "No changes to commit"
          git push origin gh-pages --force